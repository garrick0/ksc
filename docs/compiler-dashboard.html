<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KindScript Compiler Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<style>
  :root {
    --bg: #0f1117; --bg2: #161b27; --bg3: #1e2435; --bg4: #252e42;
    --border: #2a3347; --border2: #3a4560;
    --text: #e4e8f0; --text2: #8a94a8; --text3: #c0c8d8;
    --accent: #7c6af7; --accent2: #a78bfa;
    --blue: #4f8ef7; --purple: #a78bfa; --green: #4ade80; --red: #f87171;
    --orange: #fb923c; --yellow: #fbbf24; --cyan: #22d3ee; --pink: #f472b6;
    --parse-color: #4f8ef7; --bind-color: #a78bfa; --check-color: #4ade80;
    --radius: 6px; --sidebar-w: 280px;
    --mono: 'SF Mono','Fira Code','Cascadia Code','JetBrains Mono','Consolas',monospace;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow: hidden; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif; font-size: 14px; display: flex; flex-direction: column; }

  /* ---- Header ---- */
  #header {
    height: 48px; background: var(--bg2); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 16px; gap: 12px; flex-shrink: 0;
  }
  #header .logo { font-weight: 800; font-size: 15px; background: linear-gradient(135deg,#60c4f7,#a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; white-space: nowrap; }
  #header .sep { color: var(--border2); }
  #header .title { color: var(--text2); font-size: 13px; }
  #header .spacer { flex: 1; }
  #header button { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 5px 12px; color: var(--text2); cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.15s; }
  #header button:hover { border-color: var(--accent); color: var(--text); }
  #header .stats-badge { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text2); }
  #header .stats-badge strong { color: var(--text3); }

  /* ---- Main layout ---- */
  #main { display: flex; flex: 1; min-height: 0; }

  /* ---- Sidebar ---- */
  #sidebar {
    width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--bg2);
    border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden;
  }
  #sidebar-search { padding: 8px 10px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  #sidebar-search input {
    width: 100%; background: var(--bg3); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 5px 9px; color: var(--text); font-size: 12px; outline: none;
  }
  #sidebar-search input:focus { border-color: var(--accent); }
  #sidebar-search input::placeholder { color: var(--text2); }
  #sidebar-content { flex: 1; overflow-y: auto; padding: 6px 0; }
  #sidebar-content::-webkit-scrollbar { width: 4px; }
  #sidebar-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .sb-group { margin-bottom: 4px; }
  .sb-group-header {
    display: flex; align-items: center; gap: 6px; padding: 4px 10px;
    font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em;
    color: var(--text2); cursor: pointer; user-select: none;
  }
  .sb-group-header:hover { color: var(--text); }
  .sb-group-header .chevron { font-size: 9px; width: 10px; transition: transform 0.15s; }
  .sb-group-header.collapsed .chevron { transform: rotate(-90deg); }
  .sb-group-body { padding-left: 4px; }
  .sb-group-body.collapsed { display: none; }

  .sb-item {
    display: flex; align-items: center; gap: 6px; padding: 3px 10px 3px 18px;
    cursor: pointer; font-size: 12px; transition: background 0.1s; border-left: 2px solid transparent;
    white-space: nowrap; overflow: hidden;
  }
  .sb-item:hover { background: var(--bg3); }
  .sb-item.active { background: var(--bg4); border-left-color: var(--accent); }
  .sb-item .dot { width: 7px; height: 7px; border-radius: 2px; flex-shrink: 0; }
  .sb-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; color: var(--text3); }
  .sb-item:hover .name { color: var(--text); }
  .sb-item .badge { font-size: 9px; font-weight: 700; padding: 1px 5px; border-radius: 3px; flex-shrink: 0; }
  .sb-item .count { font-size: 10px; color: var(--text2); flex-shrink: 0; }

  /* ---- Content area ---- */
  #content { flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden; position: relative; }

  /* ---- Stage tabs ---- */
  #stage-tabs {
    height: 40px; background: var(--bg2); border-bottom: 1px solid var(--border);
    display: flex; align-items: stretch; padding: 0 14px; gap: 2px; flex-shrink: 0;
  }
  .stage-tab {
    display: flex; align-items: center; gap: 6px; padding: 0 18px;
    font-size: 13px; font-weight: 700; color: var(--text2);
    cursor: pointer; border-bottom: 2px solid transparent;
    transition: all 0.15s; letter-spacing: 0.03em;
  }
  .stage-tab:hover { color: var(--text); background: rgba(124,106,247,0.04); }
  .stage-tab.active { color: var(--text); }
  .stage-tab.active[data-stage="parse"] { border-bottom-color: var(--parse-color); }
  .stage-tab.active[data-stage="bind"] { border-bottom-color: var(--bind-color); }
  .stage-tab.active[data-stage="check"] { border-bottom-color: var(--check-color); }
  .stage-tab .tab-dot { width: 8px; height: 8px; border-radius: 50%; }
  .stage-tab[data-stage="parse"] .tab-dot { background: var(--parse-color); }
  .stage-tab[data-stage="bind"] .tab-dot { background: var(--bind-color); }
  .stage-tab[data-stage="check"] .tab-dot { background: var(--check-color); }
  .stage-tab .tab-count { font-size: 10px; font-weight: 600; padding: 1px 6px; border-radius: 8px; background: var(--bg3); color: var(--text2); }

  /* ---- Toolbar ---- */
  #toolbar {
    height: 36px; background: var(--bg3); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 14px; gap: 8px; flex-shrink: 0;
  }
  .view-btns { display: flex; gap: 2px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 2px; }
  .view-btn { background: transparent; border: none; padding: 3px 10px; border-radius: 4px; color: var(--text2); cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.15s; }
  .view-btn:hover { color: var(--text); background: var(--bg3); }
  .view-btn.active { background: var(--bg3); color: var(--text); border: 1px solid var(--border); }
  #toolbar .spacer { flex: 1; }
  #toolbar .legend { display: flex; gap: 10px; align-items: center; }
  .leg-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text2); }
  .leg-dot { width: 8px; height: 8px; border-radius: 2px; }

  /* ---- Viz panel ---- */
  #viz-panel { flex: 1; position: relative; overflow: hidden; }
  #viz-panel svg { position: absolute; top: 0; left: 0; }

  /* ---- Tree view styles ---- */
  .tree-link { fill: none; stroke: var(--border); stroke-width: 1.2; }
  .tree-node { cursor: pointer; }
  .tree-node-bg { fill: transparent; }
  .tree-node-bg:hover { fill: rgba(124,106,247,0.06); }
  .tree-node-label { font-family: -apple-system,sans-serif; font-size: 11px; fill: var(--text); }
  .tree-node-label.bold { font-weight: 600; }
  .tree-node-count { font-family: -apple-system,sans-serif; font-size: 9px; fill: var(--text2); }
  .tree-toggle { font-family: -apple-system,sans-serif; font-size: 9px; fill: var(--text2); cursor: pointer; }
  .tree-badge { font-family: var(--mono); font-size: 9px; font-weight: 800; }
  .tree-prop-chip { font-family: -apple-system,sans-serif; font-size: 8px; font-weight: 700; }

  /* ---- Tooltip ---- */
  #tooltip {
    position: fixed; background: var(--bg2); border: 1px solid var(--border2);
    border-radius: var(--radius); padding: 10px 13px; font-size: 12px; color: var(--text3);
    pointer-events: none; z-index: 1000; box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    max-width: 340px; display: none; line-height: 1.6;
  }
  #tooltip .tt-title { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 5px; }
  #tooltip .tt-row { display: flex; justify-content: space-between; gap: 16px; }
  #tooltip .tt-key { color: var(--text2); }
  #tooltip .tt-val { font-weight: 600; color: var(--text3); font-family: var(--mono); font-size: 11px; }
  #tooltip .tt-props { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px; }
  #tooltip .tt-chip { font-size: 9px; font-weight: 700; padding: 1px 5px; border-radius: 3px; }

  /* ---- Right detail panel ---- */
  #detail-panel {
    position: absolute; top: 0; right: 0; bottom: 0; width: 420px;
    background: var(--bg); border-left: 2px solid var(--accent);
    transform: translateX(100%); transition: transform 0.25s ease;
    display: flex; flex-direction: column; z-index: 100; overflow: hidden; pointer-events: none;
  }
  #detail-panel.open { transform: translateX(0); pointer-events: auto; }
  #dp-header {
    background: var(--bg2); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 8px 12px; gap: 8px; flex-shrink: 0;
  }
  #dp-header .dp-title { flex: 1; font-size: 13px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  #dp-header .dp-stage-badge { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; }
  #dp-close { background: none; border: none; color: var(--text2); cursor: pointer; font-size: 18px; padding: 2px 6px; }
  #dp-close:hover { color: var(--text); }
  #dp-body { flex: 1; overflow-y: auto; padding: 14px; font-size: 12px; color: var(--text3); line-height: 1.7; }
  #dp-body::-webkit-scrollbar { width: 4px; }
  #dp-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .dp-section { margin-bottom: 14px; }
  .dp-label { color: var(--text2); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
  .dp-value { color: var(--text); font-weight: 600; }
  .dp-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; }
  .dp-props { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
  .dp-prop-chip { font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 4px; border: 1px solid; }

  .dp-code-block {
    background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 10px 12px; font-family: var(--mono); font-size: 11px; line-height: 1.6;
    overflow-x: auto; white-space: pre; color: var(--text3); margin-top: 6px;
  }
  .dp-code-block .hl-line { background: rgba(248,113,113,0.12); display: block; margin: 0 -12px; padding: 0 12px; border-left: 2px solid var(--red); }
  .dp-code-block .hl-line-green { background: rgba(74,222,128,0.08); display: block; margin: 0 -12px; padding: 0 12px; border-left: 2px solid var(--green); }

  .dp-file-list { margin-top: 6px; }
  .dp-file-item { display: flex; align-items: center; gap: 6px; padding: 3px 0; font-size: 11px; font-family: var(--mono); color: var(--text2); cursor: pointer; }
  .dp-file-item:hover { color: var(--text); }
  .dp-file-item .fi-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

  .dp-nav-btn {
    display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px;
    border: 1px solid var(--border); border-radius: 4px; background: var(--bg3);
    color: var(--text2); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s; margin-top: 8px;
  }
  .dp-nav-btn:hover { border-color: var(--accent); color: var(--text); }

  .dp-diag-item { padding: 6px 8px; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 6px; background: var(--bg3); }
  .dp-diag-code { font-family: var(--mono); font-size: 10px; font-weight: 700; color: var(--red); }
  .dp-diag-msg { font-size: 11px; color: var(--text3); margin-top: 2px; }
  .dp-diag-loc { font-size: 10px; color: var(--text2); font-family: var(--mono); margin-top: 2px; }

  /* ---- Status bar ---- */
  #statusbar {
    height: 28px; background: var(--bg2); border-top: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 12px; gap: 16px; font-size: 11px; color: var(--text2); flex-shrink: 0;
  }
  #statusbar .stat { display: flex; align-items: center; gap: 4px; }
  #statusbar .stat strong { color: var(--text3); }
  .sb-dot { width: 6px; height: 6px; border-radius: 50%; }

  /* ---- Upload overlay ---- */
  #upload-overlay {
    position: fixed; inset: 0; background: rgba(15,17,23,0.92);
    display: flex; align-items: center; justify-content: center; z-index: 500; backdrop-filter: blur(4px);
  }
  #upload-overlay.hidden { display: none; }
  #upload-box {
    background: var(--bg2); border: 2px dashed var(--border2); border-radius: 12px;
    padding: 48px 60px; text-align: center; max-width: 480px; width: 90%;
  }
  #upload-box h2 { font-size: 20px; font-weight: 700; margin-bottom: 10px; }
  #upload-box p { color: var(--text2); font-size: 13px; margin-bottom: 24px; line-height: 1.6; }
  #upload-box .btns { display: flex; gap: 10px; justify-content: center; }
  #upload-box button { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 8px 18px; color: var(--text); cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.15s; }
  #upload-box button.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  #upload-box button:hover { border-color: var(--accent); }
  #upload-box button.primary:hover { background: #6b5af0; }
  #file-input { display: none; }

  /* Syntax highlighting */
  .hl-kw { color: #c586c0; }
  .hl-type { color: #4ec9b0; }
  .hl-str { color: #ce9178; }
  .hl-num { color: #b5cea8; }
  .hl-cmt { color: #6a9955; font-style: italic; }
  .hl-fn { color: #dcdcaa; }
  .hl-const { color: #4fc1ff; }
</style>
</head>
<body>

<!-- Header -->
<div id="header">
  <span class="logo">KindScript</span>
  <span class="sep">/</span>
  <span class="title">Compiler Dashboard</span>
  <div class="spacer"></div>
  <div class="stats-badge" id="hdr-stats"></div>
  <button id="load-btn" onclick="document.getElementById('upload-overlay').classList.remove('hidden')">Load JSON</button>
  <button id="sample-btn" onclick="loadData(SAMPLE_DATA)">Sample Data</button>
</div>

<!-- Main -->
<div id="main">
  <!-- Sidebar -->
  <div id="sidebar">
    <div id="sidebar-search">
      <input type="text" id="search-input" placeholder="Search..." oninput="renderSidebar()">
    </div>
    <div id="sidebar-content"></div>
  </div>

  <!-- Content -->
  <div id="content">
    <!-- Stage tabs -->
    <div id="stage-tabs">
      <div class="stage-tab active" data-stage="parse" onclick="switchStage('parse')">
        <div class="tab-dot"></div>
        <span>PARSE</span>
        <span class="tab-count" id="parse-count">0</span>
      </div>
      <div class="stage-tab" data-stage="bind" onclick="switchStage('bind')">
        <div class="tab-dot"></div>
        <span>BIND</span>
        <span class="tab-count" id="bind-count">0</span>
      </div>
      <div class="stage-tab" data-stage="check" onclick="switchStage('check')">
        <div class="tab-dot"></div>
        <span>CHECK</span>
        <span class="tab-count" id="check-count">0</span>
      </div>
    </div>

    <!-- Toolbar -->
    <div id="toolbar">
      <div class="view-btns" id="check-views" style="display:none">
        <button class="view-btn active" data-view="byFile" onclick="switchCheckView('byFile')">By File</button>
        <button class="view-btn" data-view="byProperty" onclick="switchCheckView('byProperty')">By Property</button>
      </div>
      <div class="spacer"></div>
      <div class="legend" id="toolbar-legend"></div>
    </div>

    <!-- Viz -->
    <div id="viz-panel"></div>

    <!-- Detail panel -->
    <div id="detail-panel">
      <div id="dp-header">
        <span class="dp-title" id="dp-title"></span>
        <span class="dp-stage-badge" id="dp-stage-badge"></span>
        <button id="dp-close" onclick="closeDetail()">&times;</button>
      </div>
      <div id="dp-body"></div>
    </div>
  </div>
</div>

<!-- Status bar -->
<div id="statusbar">
  <div class="stat"><div class="sb-dot" style="background:var(--parse-color)"></div><strong id="sb-files">0</strong> source files</div>
  <div class="stat"><div class="sb-dot" style="background:var(--bind-color)"></div><strong id="sb-symbols">0</strong> symbols</div>
  <div class="stat"><div class="sb-dot" style="background:var(--green)"></div><strong id="sb-clean">0</strong> clean</div>
  <div class="stat"><div class="sb-dot" style="background:var(--red)"></div><strong id="sb-diags">0</strong> diagnostics</div>
</div>

<!-- Tooltip -->
<div id="tooltip"></div>

<!-- Upload overlay -->
<div id="upload-overlay" class="hidden">
  <div id="upload-box">
    <h2>Load Dashboard Data</h2>
    <p>Drop a <code>DashboardExportData</code> JSON file here, or click to browse.<br>
       Generate with: <code>ksc dashboard --output data.json</code></p>
    <div class="btns">
      <button class="primary" onclick="document.getElementById('file-input').click()">Browse file...</button>
      <button onclick="document.getElementById('upload-overlay').classList.add('hidden')">Cancel</button>
    </div>
    <input type="file" id="file-input" accept=".json" onchange="handleFileUpload(event)">
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let data = null;
let activeStage = 'parse';
let checkView = 'byFile';
let selectedNodeId = null;
let treeNodeIdCounter = 0;

// ============================================================
// SAMPLE DATA — mirrors the checker-violations fixture
// ============================================================
const SAMPLE_DATA = {
  version: 1,
  project: {
    root: '/kindscript-project',
    generatedAt: new Date().toISOString(),
    rootFiles: ['context.ts']
  },
  parse: {
    sourceFiles: [
      {
        fileName: 'context.ts',
        lineCount: 63,
        declarations: [
          { id: 'p-1', name: 'KSDir', kind: 'TypeAliasDeclaration', pos: 0, end: 120, text: "type KSDir<Path extends string = string> = { readonly path: Path; ... }" },
          { id: 'p-2', name: 'KSFile', kind: 'TypeAliasDeclaration', pos: 121, end: 240, text: "type KSFile<Path extends string = string> = { readonly path: Path; ... }" },
          { id: 'p-3', name: 'PropertySpec', kind: 'TypeAliasDeclaration', pos: 241, end: 400, text: "type PropertySpec = { readonly pure?: true; readonly noIO?: true; ... }" },
          { id: 'p-4', name: 'Kind', kind: 'TypeAliasDeclaration', pos: 401, end: 500, text: "type Kind<Base, _Properties extends PropertySpec = {}> = Base & { ... }" },
          { id: 'p-5', name: 'NoImportsLayer', kind: 'TypeAliasDeclaration', pos: 501, end: 560, text: "type NoImportsLayer = Kind<KSDir, { noImports: true }>" },
          { id: 'p-6', name: 'NoIOLayer', kind: 'TypeAliasDeclaration', pos: 561, end: 610, text: "type NoIOLayer = Kind<KSDir, { noIO: true }>" },
          { id: 'p-7', name: 'ks', kind: 'VariableStatement', pos: 611, end: 700, text: "declare const ks: { file<P>(path: P): KSFile<P>; dir<P>(path: P): KSDir<P> }" },
          { id: 'p-8', name: 'noConsoleFunc', kind: 'VariableStatement', pos: 701, end: 770, text: "const noConsoleFunc: Kind<() => void, { noConsole: true }> = () => { console.log('hello') }" },
          { id: 'p-9', name: 'noMutationFunc', kind: 'VariableStatement', pos: 771, end: 850, text: "const noMutationFunc: Kind<(arr: number[]) => void, { noMutation: true }> = (arr) => { ... }" },
          { id: 'p-10', name: 'domainDir', kind: 'VariableStatement', pos: 851, end: 910, text: "const domainDir: NoImportsLayer = ks.dir('./src/domain')" },
          { id: 'p-11', name: 'infraDir', kind: 'VariableStatement', pos: 911, end: 970, text: "const infraDir: NoIOLayer = ks.dir('./src/infra')" }
        ],
        source: "// Test fixture: values that VIOLATE their declared properties.\n\ntype KSDir<Path extends string = string> = {\n  readonly path: Path;\n  readonly name: string;\n  readonly __ks?: true;\n};\n\ntype KSFile<Path extends string = string> = {\n  readonly path: Path;\n  readonly filename: string;\n  readonly extension: string;\n  readonly __ks?: true;\n};\n\ntype PropertySpec = {\n  readonly pure?: true;\n  readonly noIO?: true;\n  readonly noImports?: true;\n  readonly noConsole?: true;\n  readonly immutable?: true;\n  readonly static?: true;\n  readonly noSideEffects?: true;\n  readonly noMutation?: true;\n  readonly maxFanOut?: number;\n};\n\ntype Kind<\n  Base = unknown,\n  _Properties extends PropertySpec = {},\n> = Base & {\n  readonly __ks?: true;\n};\n\ndeclare const ks: {\n  file<P extends string>(path: P): KSFile<P>;\n  dir<P extends string>(path: P): KSDir<P>;\n};\n\n// noConsole violation\nconst noConsoleFunc: Kind<() => void, { noConsole: true }> =\n  () => {\n    console.log('hello');\n  };\n\n// noMutation violation\nconst noMutationFunc: Kind<(arr: number[]) => void, { noMutation: true }> =\n  (arr) => {\n    let x = 0;\n    x = 1;\n    x++;\n  };\n\ntype NoImportsLayer = Kind<KSDir, { noImports: true }>;\nconst domainDir: NoImportsLayer = ks.dir('./src/domain');\n\ntype NoIOLayer = Kind<KSDir, { noIO: true }>;\nconst infraDir: NoIOLayer = ks.dir('./src/infra');\n"
      },
      {
        fileName: 'src/domain/handler.ts',
        lineCount: 9,
        declarations: [
          { id: 'p-20', name: 'handle', kind: 'FunctionDeclaration', pos: 0, end: 120, text: "export function handle() { return something(); }" }
        ],
        source: "// This file is inside the domain directory.\n// It has an import — violating noImports.\n\nimport { something } from './other';\n\nexport function handle() {\n  return something();\n}\n"
      },
      {
        fileName: 'src/domain/other.ts',
        lineCount: 5,
        declarations: [
          { id: 'p-21', name: 'something', kind: 'FunctionDeclaration', pos: 0, end: 80, text: "export function something() { return 42; }" }
        ],
        source: "// Helper module in domain directory.\n\nexport function something() {\n  return 42;\n}\n"
      },
      {
        fileName: 'src/infra/db.ts',
        lineCount: 9,
        declarations: [
          { id: 'p-30', name: 'loadConfig', kind: 'FunctionDeclaration', pos: 0, end: 120, text: "export function loadConfig(path: string) { return readFileSync(path, 'utf-8'); }" }
        ],
        source: "// This file is inside the infra directory.\n// It imports an IO module — violating noIO.\n\nimport { readFileSync } from 'fs';\n\nexport function loadConfig(path: string) {\n  return readFileSync(path, 'utf-8');\n}\n"
      },
      {
        fileName: 'src/pure/math.ts',
        lineCount: 12,
        declarations: [
          { id: 'p-40', name: 'PI', kind: 'VariableStatement', pos: 0, end: 40, text: "export const PI = 3.14159" },
          { id: 'p-41', name: 'add', kind: 'FunctionDeclaration', pos: 41, end: 100, text: "export function add(a: number, b: number): number { return a + b; }" },
          { id: 'p-42', name: 'multiply', kind: 'FunctionDeclaration', pos: 101, end: 170, text: "export function multiply(a: number, b: number): number { return a * b; }" }
        ],
        source: "// A clean file: only const declarations, pure functions, no console.\n\nexport const PI = 3.14159;\n\nexport function add(a: number, b: number): number {\n  return a + b;\n}\n\nexport function multiply(a: number, b: number): number {\n  return a * b;\n}\n"
      }
    ]
  },
  bind: {
    symbols: [
      // Definitions
      { id: 'b-1', name: 'NoImportsLayer', role: 'definition', valueKind: 'composite', declaredProperties: { noImports: true }, sourceFile: 'context.ts', sourcePos: 501, parseNodeId: 'p-5' },
      { id: 'b-2', name: 'NoIOLayer', role: 'definition', valueKind: 'composite', declaredProperties: { noIO: true }, sourceFile: 'context.ts', sourcePos: 561, parseNodeId: 'p-6' },
      // Values
      { id: 'b-10', name: 'noConsoleFunc', role: 'value', valueKind: 'function', declaredProperties: { noConsole: true }, kindDefinitionId: null, sourceFile: 'context.ts', sourcePos: 701, parseNodeId: 'p-8' },
      { id: 'b-11', name: 'noMutationFunc', role: 'value', valueKind: 'function', declaredProperties: { noMutation: true }, kindDefinitionId: null, sourceFile: 'context.ts', sourcePos: 771, parseNodeId: 'p-9' },
      { id: 'b-12', name: 'domainDir', role: 'value', valueKind: 'directory', declaredProperties: { noImports: true }, path: './src/domain', resolvedFiles: ['src/domain/handler.ts', 'src/domain/other.ts'], kindDefinitionId: 'b-1', sourceFile: 'context.ts', sourcePos: 851, parseNodeId: 'p-10' },
      { id: 'b-13', name: 'infraDir', role: 'value', valueKind: 'directory', declaredProperties: { noIO: true }, path: './src/infra', resolvedFiles: ['src/infra/db.ts'], kindDefinitionId: 'b-2', sourceFile: 'context.ts', sourcePos: 911, parseNodeId: 'p-11' },
      { id: 'b-14', name: 'pureDir', role: 'value', valueKind: 'directory', declaredProperties: { pure: true, noIO: true, noImports: true }, path: './src/pure', resolvedFiles: ['src/pure/math.ts'], kindDefinitionId: null, sourceFile: 'context.ts', sourcePos: 0, parseNodeId: null }
    ]
  },
  check: {
    diagnostics: [
      { id: 'c-1', file: 'context.ts', code: 70009, property: 'noConsole', message: "Kind property 'noConsole' violated: console usage is not allowed. First violation: console.log('hello')", start: 701, length: 50, line: 43, column: 6, symbolId: 'b-10' },
      { id: 'c-2', file: 'context.ts', code: 70013, property: 'noMutation', message: "Kind property 'noMutation' violated: mutation is not allowed. First violation: assignment to 'x'", start: 771, length: 50, line: 50, column: 6, symbolId: 'b-11' },
      { id: 'c-3', file: 'src/domain/handler.ts', code: 70008, property: 'noImports', message: "Kind property 'noImports' violated: import declarations are not allowed. Found: import { something } from './other'", start: 0, length: 35, line: 4, column: 0, symbolId: 'b-12' },
      { id: 'c-4', file: 'src/infra/db.ts', code: 70007, property: 'noIO', message: "Kind property 'noIO' violated: IO module imports are not allowed. Found: import from 'fs'", start: 0, length: 34, line: 4, column: 0, symbolId: 'b-13' }
    ],
    summary: {
      totalFiles: 5,
      totalSymbols: 7,
      totalDiagnostics: 4,
      cleanFiles: 3,
      violatingFiles: 2,
      byProperty: {
        noConsole: { checked: 1, violations: 1 },
        noMutation: { checked: 1, violations: 1 },
        noImports: { checked: 1, violations: 1 },
        noIO: { checked: 1, violations: 1 },
        pure: { checked: 1, violations: 0 },
        noSideEffects: { checked: 0, violations: 0 },
        immutable: { checked: 0, violations: 0 }
      }
    }
  }
};

// ============================================================
// DATA LOADING
// ============================================================
function loadData(d) {
  data = d;
  updateCounts();
  updateStatusBar();
  renderSidebar();
  renderTree();
}

function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const d = JSON.parse(ev.target.result);
      document.getElementById('upload-overlay').classList.add('hidden');
      loadData(d);
    } catch (err) { alert('Invalid JSON: ' + err.message); }
  };
  reader.readAsText(file);
}

// ============================================================
// STAGE SWITCHING
// ============================================================
function switchStage(stage) {
  activeStage = stage;
  document.querySelectorAll('.stage-tab').forEach(t => t.classList.toggle('active', t.dataset.stage === stage));
  document.getElementById('check-views').style.display = stage === 'check' ? 'flex' : 'none';
  closeDetail();
  renderSidebar();
  renderTree();
  updateLegend();
}

function switchCheckView(view) {
  checkView = view;
  document.querySelectorAll('#check-views .view-btn').forEach(b => b.classList.toggle('active', b.dataset.view === view));
  renderTree();
}

// ============================================================
// COUNTS & STATUS BAR
// ============================================================
function updateCounts() {
  if (!data) return;
  document.getElementById('parse-count').textContent = data.parse.sourceFiles.length;
  document.getElementById('bind-count').textContent = data.bind.symbols.length;
  document.getElementById('check-count').textContent = data.check.diagnostics.length;
}

function updateStatusBar() {
  if (!data) return;
  document.getElementById('sb-files').textContent = data.parse.sourceFiles.length;
  document.getElementById('sb-symbols').textContent = data.bind.symbols.length;
  document.getElementById('sb-clean').textContent = data.check.summary.cleanFiles;
  document.getElementById('sb-diags').textContent = data.check.diagnostics.length;
  document.getElementById('hdr-stats').innerHTML =
    '<strong>' + data.parse.sourceFiles.length + '</strong> files' +
    ' &middot; <strong>' + data.bind.symbols.length + '</strong> symbols' +
    ' &middot; <strong>' + data.check.diagnostics.length + '</strong> diagnostics';
}

function updateLegend() {
  const el = document.getElementById('toolbar-legend');
  if (activeStage === 'parse') {
    el.innerHTML = [
      leg('T','var(--cyan)','TypeAlias'), leg('V','var(--blue)','Variable'),
      leg('F','var(--yellow)','Function'), leg('I','var(--green)','Interface')
    ].join('');
  } else if (activeStage === 'bind') {
    el.innerHTML = [
      leg('D','var(--purple)','Definition'), leg('fn','var(--yellow)','Function'),
      leg('dir','var(--blue)','Directory'), leg('file','var(--cyan)','File')
    ].join('');
  } else {
    el.innerHTML = [
      leg('','var(--green)','Clean'), leg('','var(--red)','Violation')
    ].join('');
  }
}
function leg(label, color, text) {
  return '<div class="leg-item"><div class="leg-dot" style="background:' + color + '"></div>' + text + '</div>';
}

// ============================================================
// SIDEBAR
// ============================================================
function renderSidebar() {
  if (!data) return;
  const el = document.getElementById('sidebar-content');
  const query = document.getElementById('search-input').value.toLowerCase();
  el.innerHTML = '';

  if (activeStage === 'parse') renderParseSidebar(el, query);
  else if (activeStage === 'bind') renderBindSidebar(el, query);
  else renderCheckSidebar(el, query);
}

function renderParseSidebar(el, query) {
  data.parse.sourceFiles.forEach(sf => {
    if (query && !sf.fileName.toLowerCase().includes(query) && !sf.declarations.some(d => d.name.toLowerCase().includes(query))) return;
    const group = document.createElement('div');
    group.className = 'sb-group';
    const hdr = document.createElement('div');
    hdr.className = 'sb-group-header';
    hdr.innerHTML = '<span class="chevron">&#9662;</span> ' + escHtml(shortFileName(sf.fileName)) +
      ' <span style="color:var(--text2);font-size:10px;font-weight:400">(' + sf.declarations.length + ')</span>';
    hdr.onclick = () => toggleSbGroup(hdr);
    group.appendChild(hdr);

    const body = document.createElement('div');
    body.className = 'sb-group-body';
    sf.declarations.forEach(d => {
      if (query && !d.name.toLowerCase().includes(query)) return;
      const item = document.createElement('div');
      item.className = 'sb-item';
      item.dataset.id = d.id;
      item.innerHTML = '<div class="dot" style="background:' + kindColor(d.kind) + '"></div>' +
        '<span class="badge" style="background:' + kindColor(d.kind) + ';color:#fff">' + kindBadge(d.kind) + '</span>' +
        '<span class="name">' + escHtml(d.name) + '</span>';
      item.onclick = () => { selectSidebarItem(item); showParseDetail(sf, d); highlightTreeNode(d.id); };
      body.appendChild(item);
    });
    group.appendChild(body);
    el.appendChild(group);
  });
}

function renderBindSidebar(el, query) {
  const defs = data.bind.symbols.filter(s => s.role === 'definition');
  const vals = data.bind.symbols.filter(s => s.role === 'value');

  [{ label: 'Definitions', items: defs, color: 'var(--purple)' },
   { label: 'Values', items: vals, color: 'var(--blue)' }].forEach(grp => {
    const filtered = grp.items.filter(s => !query || s.name.toLowerCase().includes(query));
    if (filtered.length === 0) return;
    const group = document.createElement('div');
    group.className = 'sb-group';
    const hdr = document.createElement('div');
    hdr.className = 'sb-group-header';
    hdr.innerHTML = '<span class="chevron">&#9662;</span> ' + grp.label +
      ' <span style="color:var(--text2);font-size:10px;font-weight:400">(' + filtered.length + ')</span>';
    hdr.onclick = () => toggleSbGroup(hdr);
    group.appendChild(hdr);

    const body = document.createElement('div');
    body.className = 'sb-group-body';
    filtered.forEach(s => {
      const item = document.createElement('div');
      item.className = 'sb-item';
      item.dataset.id = s.id;
      item.innerHTML = '<div class="dot" style="background:' + valueKindColor(s) + '"></div>' +
        '<span class="name">' + escHtml(s.name) + '</span>' +
        (s.valueKind ? '<span class="count">' + s.valueKind + '</span>' : '') +
        propsChips(s.declaredProperties);
      item.onclick = () => { selectSidebarItem(item); showBindDetail(s); highlightTreeNode(s.id); };
      body.appendChild(item);
    });
    group.appendChild(body);
    el.appendChild(group);
  });
}

function renderCheckSidebar(el, query) {
  // Group diagnostics by file
  const byFile = {};
  data.check.diagnostics.forEach(d => {
    if (!byFile[d.file]) byFile[d.file] = [];
    byFile[d.file].push(d);
  });

  // Files with diagnostics
  Object.keys(byFile).forEach(file => {
    if (query && !file.toLowerCase().includes(query) && !byFile[file].some(d => d.message.toLowerCase().includes(query))) return;
    const group = document.createElement('div');
    group.className = 'sb-group';
    const hdr = document.createElement('div');
    hdr.className = 'sb-group-header';
    hdr.innerHTML = '<span class="chevron">&#9662;</span> ' +
      '<span style="color:var(--red)">&#9679;</span> ' + escHtml(shortFileName(file)) +
      ' <span style="color:var(--red);font-size:10px;font-weight:400">(' + byFile[file].length + ')</span>';
    hdr.onclick = () => toggleSbGroup(hdr);
    group.appendChild(hdr);

    const body = document.createElement('div');
    body.className = 'sb-group-body';
    byFile[file].forEach(d => {
      if (query && !d.message.toLowerCase().includes(query) && !d.property.toLowerCase().includes(query)) return;
      const item = document.createElement('div');
      item.className = 'sb-item';
      item.dataset.id = d.id;
      item.innerHTML = '<div class="dot" style="background:var(--red)"></div>' +
        '<span class="badge" style="background:rgba(248,113,113,0.15);color:var(--red)">KS' + d.code + '</span>' +
        '<span class="name">' + escHtml(d.property) + '</span>' +
        '<span class="count">L' + d.line + '</span>';
      item.onclick = () => { selectSidebarItem(item); showCheckDetail(d); highlightTreeNode(d.id); };
      body.appendChild(item);
    });
    group.appendChild(body);
    el.appendChild(group);
  });

  // Clean files
  const diagFiles = new Set(data.check.diagnostics.map(d => d.file));
  const cleanFiles = data.parse.sourceFiles.filter(sf => !diagFiles.has(sf.fileName));
  if (cleanFiles.length > 0) {
    const group = document.createElement('div');
    group.className = 'sb-group';
    const hdr = document.createElement('div');
    hdr.className = 'sb-group-header collapsed';
    hdr.innerHTML = '<span class="chevron">&#9662;</span> ' +
      '<span style="color:var(--green)">&#9679;</span> Clean Files' +
      ' <span style="color:var(--green);font-size:10px;font-weight:400">(' + cleanFiles.length + ')</span>';
    hdr.onclick = () => toggleSbGroup(hdr);
    group.appendChild(hdr);

    const body = document.createElement('div');
    body.className = 'sb-group-body collapsed';
    cleanFiles.forEach(sf => {
      const item = document.createElement('div');
      item.className = 'sb-item';
      item.innerHTML = '<div class="dot" style="background:var(--green)"></div>' +
        '<span class="name">' + escHtml(shortFileName(sf.fileName)) + '</span>' +
        '<span class="count" style="color:var(--green)">&#10003;</span>';
      body.appendChild(item);
    });
    group.appendChild(body);
    el.appendChild(group);
  }
}

function toggleSbGroup(hdr) {
  hdr.classList.toggle('collapsed');
  const body = hdr.nextElementSibling;
  if (body) body.classList.toggle('collapsed');
}

function selectSidebarItem(item) {
  document.querySelectorAll('.sb-item.active').forEach(i => i.classList.remove('active'));
  item.classList.add('active');
}

// ============================================================
// DETAIL PANEL
// ============================================================
function openDetail(title, stageName, stageColor, bodyHtml) {
  document.getElementById('dp-title').textContent = title;
  const badge = document.getElementById('dp-stage-badge');
  badge.textContent = stageName;
  badge.style.background = stageColor + '22';
  badge.style.color = stageColor;
  document.getElementById('dp-body').innerHTML = bodyHtml;
  document.getElementById('detail-panel').classList.add('open');
}

function closeDetail() {
  document.getElementById('detail-panel').classList.remove('open');
}

function showParseDetail(sf, decl) {
  let html = '<div class="dp-section"><div class="dp-label">File</div><div class="dp-value">' + escHtml(sf.fileName) + '</div></div>';
  html += '<div class="dp-section"><div class="dp-label">Kind</div><div class="dp-badge" style="background:' + kindColor(decl.kind) + ';color:#fff">' + decl.kind + '</div></div>';
  html += '<div class="dp-section"><div class="dp-label">Position</div><div class="dp-value" style="font-family:var(--mono);font-size:11px">pos: ' + decl.pos + ' — end: ' + decl.end + '</div></div>';
  html += '<div class="dp-section"><div class="dp-label">Source Preview</div><div class="dp-code-block">' + escHtml(decl.text) + '</div></div>';

  // Cross-stage link to bind
  const bindSym = data.bind.symbols.find(s => s.parseNodeId === decl.id);
  if (bindSym) {
    html += '<div class="dp-section"><button class="dp-nav-btn" onclick="navigateToSymbol(\'' + bindSym.id + '\')">Show in Bind &#8594;</button></div>';
  }

  if (sf.source) {
    html += '<div class="dp-section"><div class="dp-label">Full Source</div><div class="dp-code-block">' + highlightSource(sf.source) + '</div></div>';
  }
  openDetail(decl.name, 'PARSE', '#4f8ef7', html);
}

function showBindDetail(sym) {
  let html = '<div class="dp-section"><div class="dp-label">Role</div><div class="dp-badge" style="background:' + valueKindColor(sym) + '22;color:' + valueKindColor(sym) + '">' + sym.role + '</div></div>';
  if (sym.valueKind) {
    html += '<div class="dp-section"><div class="dp-label">Value Kind</div><div class="dp-value">' + sym.valueKind + '</div></div>';
  }
  html += '<div class="dp-section"><div class="dp-label">Source</div><div class="dp-value" style="font-family:var(--mono);font-size:11px">' + escHtml(sym.sourceFile) + '</div></div>';

  // Properties
  const props = sym.declaredProperties;
  const propKeys = Object.keys(props).filter(k => props[k]);
  if (propKeys.length > 0) {
    html += '<div class="dp-section"><div class="dp-label">Declared Properties</div><div class="dp-props">';
    propKeys.forEach(p => {
      html += '<span class="dp-prop-chip" style="border-color:var(--green);color:var(--green);background:rgba(74,222,128,0.08)">' + p + (typeof props[p] === 'number' ? ': ' + props[p] : '') + '</span>';
    });
    html += '</div></div>';
  }

  // Path
  if (sym.path) {
    html += '<div class="dp-section"><div class="dp-label">Path</div><div class="dp-value" style="font-family:var(--mono);font-size:11px">' + escHtml(sym.path) + '</div></div>';
  }

  // Resolved files
  if (sym.resolvedFiles && sym.resolvedFiles.length > 0) {
    html += '<div class="dp-section"><div class="dp-label">Resolved Files (' + sym.resolvedFiles.length + ')</div><div class="dp-file-list">';
    sym.resolvedFiles.forEach(f => {
      const hasDiag = data.check.diagnostics.some(d => d.file === f);
      html += '<div class="dp-file-item"><div class="fi-dot" style="background:' + (hasDiag ? 'var(--red)' : 'var(--green)') + '"></div>' + escHtml(f) + '</div>';
    });
    html += '</div></div>';
  }

  // Kind definition link
  if (sym.kindDefinitionId) {
    const def = data.bind.symbols.find(s => s.id === sym.kindDefinitionId);
    if (def) {
      html += '<div class="dp-section"><div class="dp-label">Kind Definition</div><div class="dp-value">' + escHtml(def.name) + '</div></div>';
    }
  }

  // Cross-stage: diagnostics for this symbol
  const diags = data.check.diagnostics.filter(d => d.symbolId === sym.id);
  if (diags.length > 0) {
    html += '<div class="dp-section"><div class="dp-label">Diagnostics (' + diags.length + ')</div>';
    diags.forEach(d => {
      html += '<div class="dp-diag-item"><div class="dp-diag-code">KS' + d.code + ' &mdash; ' + d.property + '</div><div class="dp-diag-msg">' + escHtml(d.message) + '</div><div class="dp-diag-loc">' + escHtml(d.file) + ':' + d.line + '</div></div>';
    });
    html += '<button class="dp-nav-btn" onclick="switchStage(\'check\')">Show in Check &#8594;</button>';
    html += '</div>';
  } else {
    html += '<div class="dp-section" style="color:var(--green);font-weight:600">&#10003; No violations</div>';
  }

  openDetail(sym.name, 'BIND', '#a78bfa', html);
}

function showCheckDetail(diag) {
  let html = '<div class="dp-section"><div class="dp-label">Error Code</div><div class="dp-badge" style="background:rgba(248,113,113,0.15);color:var(--red)">KS' + diag.code + '</div></div>';
  html += '<div class="dp-section"><div class="dp-label">Property</div><div class="dp-prop-chip" style="border-color:var(--red);color:var(--red);background:rgba(248,113,113,0.08);display:inline-block">' + diag.property + '</div></div>';
  html += '<div class="dp-section"><div class="dp-label">Message</div><div style="color:var(--text)">' + escHtml(diag.message) + '</div></div>';
  html += '<div class="dp-section"><div class="dp-label">Location</div><div class="dp-value" style="font-family:var(--mono);font-size:11px">' + escHtml(diag.file) + ':' + diag.line + ':' + diag.column + '</div></div>';

  // Show source with violation highlighted
  const sf = data.parse.sourceFiles.find(f => f.fileName === diag.file);
  if (sf && sf.source) {
    const lines = sf.source.split('\n');
    let codeHtml = '';
    lines.forEach((line, i) => {
      const lineNum = i + 1;
      const isViolation = lineNum === diag.line;
      const cls = isViolation ? 'hl-line' : '';
      codeHtml += '<span class="' + cls + '">' + padNum(lineNum) + ' ' + escHtml(line) + '</span>\n';
    });
    html += '<div class="dp-section"><div class="dp-label">Source</div><div class="dp-code-block">' + codeHtml + '</div></div>';
  }

  // Cross-stage links
  if (diag.symbolId) {
    html += '<div class="dp-section"><button class="dp-nav-btn" onclick="navigateToSymbol(\'' + diag.symbolId + '\')">Show Symbol in Bind &#8594;</button></div>';
  }

  openDetail('KS' + diag.code + ': ' + diag.property, 'CHECK', diag.code ? '#f87171' : '#4ade80', html);
}

function navigateToSymbol(symId) {
  switchStage('bind');
  setTimeout(() => {
    highlightTreeNode(symId);
    const sym = data.bind.symbols.find(s => s.id === symId);
    if (sym) showBindDetail(sym);
    // Highlight sidebar item
    const item = document.querySelector('.sb-item[data-id="' + symId + '"]');
    if (item) { selectSidebarItem(item); item.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
  }, 50);
}

// ============================================================
// D3 TREE RENDERING
// ============================================================
function renderTree() {
  if (!data) return;
  const panel = document.getElementById('viz-panel');
  const W = panel.clientWidth, H = panel.clientHeight;
  if (W === 0 || H === 0) return;
  panel.innerHTML = '';
  treeNodeIdCounter = 0;

  let treeData;
  if (activeStage === 'parse') treeData = buildParseTree();
  else if (activeStage === 'bind') treeData = buildBindTree();
  else treeData = checkView === 'byFile' ? buildCheckTreeByFile() : buildCheckTreeByProperty();

  const root = d3.hierarchy(treeData);
  root.each(d => { d._uid = ++treeNodeIdCounter; });

  // Auto-collapse depth >= 3
  root.each(d => {
    if (d.children && d.depth >= 3) {
      d._children = d.children;
      d.children = null;
    }
  });

  const nodeH = 28;
  const levelW = 200;
  const margin = { top: 40, left: 80, right: 40, bottom: 40 };
  const svgW = Math.max(W, 4000), svgH = Math.max(H, 4000);

  const svg = d3.select(panel).append('svg')
    .attr('width', svgW).attr('height', svgH)
    .style('font-family', '-apple-system,sans-serif');

  const g = svg.append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

  const zoom = d3.zoom().scaleExtent([0.15, 3]).on('zoom', e => g.attr('transform', e.transform));
  svg.call(zoom);
  svg.call(zoom.transform, d3.zoomIdentity.translate(margin.left, margin.top));

  const treeLay = d3.tree().nodeSize([nodeH, levelW]);

  function linkPath(s, t) {
    return 'M' + s.y + ',' + s.x + 'C' + ((s.y + t.y) / 2) + ',' + s.x + ' ' + ((s.y + t.y) / 2) + ',' + t.x + ' ' + t.y + ',' + t.x;
  }

  function update(source) {
    treeLay(root);
    const nodes = root.descendants();
    const links = root.links();

    // Links
    const link = g.selectAll('path.tree-link').data(links, d => d.target._uid);
    const linkEnter = link.enter().insert('path', 'g')
      .attr('class', 'tree-link')
      .attr('d', () => {
        const o = { x: source.x0 !== undefined ? source.x0 : source.x, y: source.y0 !== undefined ? source.y0 : source.y };
        return linkPath(o, o);
      });
    linkEnter.merge(link).transition().duration(350).attr('d', d => linkPath(d.source, d.target));
    link.exit().transition().duration(350).attr('d', () => { const o = { x: source.x, y: source.y }; return linkPath(o, o); }).remove();

    // Nodes
    const node = g.selectAll('g.tree-node').data(nodes, d => d._uid);
    const nodeEnter = node.enter().append('g')
      .attr('class', 'tree-node')
      .attr('transform', () => {
        const sx = source.x0 !== undefined ? source.x0 : source.x;
        const sy = source.y0 !== undefined ? source.y0 : source.y;
        return 'translate(' + sy + ',' + sx + ')';
      });

    // Invisible bg rect
    nodeEnter.append('rect')
      .attr('class', 'tree-node-bg')
      .attr('x', -4).attr('y', -nodeH / 2)
      .attr('width', levelW - 10).attr('height', nodeH)
      .attr('rx', 3);

    // Toggle
    nodeEnter.filter(d => d.data.children && d.data.children.length > 0 || d.children || d._children)
      .append('text')
      .attr('class', 'tree-toggle')
      .attr('x', -14).attr('dy', '0.35em').attr('text-anchor', 'middle');

    // Node dot
    nodeEnter.append('circle')
      .attr('r', d => d.data._isGroup ? 6 : d.data._isFile || d.data._isDir ? 5 : 3.5)
      .attr('fill', d => d.data.color || '#4a5578')
      .attr('stroke', d => d.data.strokeColor || 'transparent')
      .attr('stroke-width', 1.5);

    // Badge (kind indicator)
    nodeEnter.filter(d => d.data.badge)
      .append('rect')
      .attr('x', 8).attr('y', -7).attr('width', d => d.data.badge.length * 6 + 6).attr('height', 14)
      .attr('rx', 2).attr('fill', d => d.data.badgeColor || '#555');
    nodeEnter.filter(d => d.data.badge)
      .append('text')
      .attr('class', 'tree-badge')
      .attr('x', 11).attr('dy', '0.35em')
      .attr('fill', '#fff')
      .text(d => d.data.badge);

    // Label
    nodeEnter.append('text')
      .attr('class', d => 'tree-node-label' + (d.data._isGroup || d.data._isFile || d.data._isDir ? ' bold' : ''))
      .attr('x', d => d.data.badge ? d.data.badge.length * 6 + 18 : 10)
      .attr('dy', '0.35em')
      .text(d => {
        let name = d.data.name;
        if (name.length > 32) name = name.slice(0, 30) + '...';
        return name;
      });

    // Count
    nodeEnter.filter(d => d.data.countText)
      .append('text')
      .attr('class', 'tree-node-count')
      .attr('dy', '0.35em')
      .text(d => d.data.countText);

    // Property chips for bind nodes
    nodeEnter.filter(d => d.data.propChips && d.data.propChips.length > 0).each(function(d) {
      const sel = d3.select(this);
      let xOff = (d.data.badge ? d.data.badge.length * 6 + 18 : 10) + (d.data.name.length > 32 ? 30 * 6.5 : d.data.name.length * 6.5) + 8;
      d.data.propChips.forEach(chip => {
        sel.append('rect')
          .attr('x', xOff).attr('y', -6).attr('width', chip.length * 5.5 + 8).attr('height', 12)
          .attr('rx', 3).attr('fill', chip.color + '22').attr('stroke', chip.color).attr('stroke-width', 0.5);
        sel.append('text')
          .attr('class', 'tree-prop-chip')
          .attr('x', xOff + 4).attr('dy', '0.3em')
          .attr('fill', chip.color)
          .text(chip.label);
        xOff += chip.length * 5.5 + 12;
      });
    });

    // Click handler
    nodeEnter.on('click', (e, d) => {
      if (d.children) { d._children = d.children; d.children = null; }
      else if (d._children) { d.children = d._children; d._children = null; }
      else {
        // Leaf: open detail
        if (d.data.onClick) d.data.onClick();
        return;
      }
      update(d);
    });

    // Hover
    nodeEnter.on('mousemove', (e, d) => { if (d.data.tooltip) showTooltip(e, d.data.tooltip); });
    nodeEnter.on('mouseleave', () => hideTooltip());

    // Update positions
    const nodeUpdate = nodeEnter.merge(node);
    nodeUpdate.transition().duration(350).attr('transform', d => 'translate(' + d.y + ',' + d.x + ')');

    // Update toggle text
    nodeUpdate.select('.tree-toggle').text(d => d.children ? '\u25BE' : '\u25B8');

    // Remove
    node.exit().transition().duration(350).attr('transform', () => 'translate(' + source.y + ',' + source.x + ')').remove();

    // Save old positions
    nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
  }

  update(root);
  updateLegend();
}

// ============================================================
// TREE DATA BUILDERS
// ============================================================
function buildParseTree() {
  return {
    name: 'Program',
    _isGroup: true,
    color: 'var(--parse-color)',
    tooltip: { title: 'Program', rows: [['Files', data.parse.sourceFiles.length + '']] },
    children: data.parse.sourceFiles.map(sf => ({
      name: shortFileName(sf.fileName),
      _isFile: true,
      color: 'var(--parse-color)',
      badge: null,
      countText: '(' + sf.declarations.length + ' decls, ' + sf.lineCount + ' lines)',
      tooltip: { title: sf.fileName, rows: [['Lines', sf.lineCount + ''], ['Declarations', sf.declarations.length + '']] },
      onClick: () => showParseDetail(sf, sf.declarations[0]),
      children: sf.declarations.map(d => ({
        id: d.id,
        name: d.name,
        color: kindColor(d.kind),
        badge: kindBadge(d.kind),
        badgeColor: kindColor(d.kind),
        tooltip: { title: d.name, rows: [['Kind', d.kind], ['Position', d.pos + ' — ' + d.end]] },
        onClick: () => showParseDetail(sf, d),
        children: []
      }))
    }))
  };
}

function buildBindTree() {
  const defs = data.bind.symbols.filter(s => s.role === 'definition');
  const vals = data.bind.symbols.filter(s => s.role === 'value');

  return {
    name: 'KindSymbolTable',
    _isGroup: true,
    color: 'var(--bind-color)',
    tooltip: { title: 'KindSymbolTable', rows: [['Symbols', data.bind.symbols.length + ''], ['Definitions', defs.length + ''], ['Values', vals.length + '']] },
    children: [
      {
        name: 'Definitions',
        _isGroup: true,
        color: 'var(--purple)',
        countText: '(' + defs.length + ')',
        children: defs.map(s => buildBindNode(s))
      },
      {
        name: 'Values',
        _isGroup: true,
        color: 'var(--blue)',
        countText: '(' + vals.length + ')',
        children: vals.map(s => buildBindNode(s))
      }
    ]
  };
}

function buildBindNode(sym) {
  const props = sym.declaredProperties;
  const propKeys = Object.keys(props).filter(k => props[k]);
  const hasDiags = data.check.diagnostics.some(d => d.symbolId === sym.id);
  const chips = propKeys.map(p => ({
    label: p, length: p.length,
    color: hasDiags ? '#f87171' : '#4ade80'
  }));

  const rows = [['Role', sym.role]];
  if (sym.valueKind) rows.push(['Value Kind', sym.valueKind]);
  if (sym.path) rows.push(['Path', sym.path]);
  if (sym.resolvedFiles) rows.push(['Resolved Files', sym.resolvedFiles.length + '']);
  rows.push(['Properties', propKeys.join(', ') || 'none']);

  return {
    id: sym.id,
    name: sym.name,
    color: valueKindColor(sym),
    strokeColor: hasDiags ? 'var(--red)' : undefined,
    badge: sym.role === 'definition' ? 'DEF' : vkBadge(sym.valueKind),
    badgeColor: valueKindColor(sym),
    propChips: chips,
    tooltip: { title: sym.name, rows: rows, props: propKeys },
    onClick: () => showBindDetail(sym),
    children: (sym.resolvedFiles || []).map(f => {
      const fileDiag = data.check.diagnostics.some(d => d.file === f);
      return {
        name: shortFileName(f),
        _isFile: true,
        color: fileDiag ? 'var(--red)' : 'var(--green)',
        tooltip: { title: f, rows: [['Status', fileDiag ? 'Has violations' : 'Clean']] },
        onClick: () => {
          const sf = data.parse.sourceFiles.find(s => s.fileName === f);
          if (sf) showParseDetail(sf, sf.declarations[0]);
        },
        children: []
      };
    })
  };
}

function buildCheckTreeByFile() {
  const byFile = {};
  data.check.diagnostics.forEach(d => {
    if (!byFile[d.file]) byFile[d.file] = [];
    byFile[d.file].push(d);
  });
  const diagFiles = Object.keys(byFile);
  const cleanFiles = data.parse.sourceFiles.filter(sf => !byFile[sf.fileName]);

  return {
    name: 'Diagnostics (' + data.check.diagnostics.length + ' errors)',
    _isGroup: true,
    color: data.check.diagnostics.length > 0 ? 'var(--red)' : 'var(--green)',
    tooltip: { title: 'Check Results', rows: [['Total', data.check.diagnostics.length + ''], ['Files with errors', diagFiles.length + ''], ['Clean files', cleanFiles.length + '']] },
    children: [
      ...diagFiles.map(file => ({
        name: shortFileName(file),
        _isFile: true,
        color: 'var(--red)',
        countText: '(' + byFile[file].length + ' errors)',
        tooltip: { title: file, rows: [['Errors', byFile[file].length + '']] },
        children: byFile[file].map(d => ({
          id: d.id,
          name: 'KS' + d.code + ': ' + d.property,
          color: 'var(--red)',
          badge: 'KS' + d.code,
          badgeColor: '#dc2626',
          tooltip: { title: 'KS' + d.code, rows: [['Property', d.property], ['Line', d.line + ''], ['Message', d.message.slice(0, 80)]] },
          onClick: () => showCheckDetail(d),
          children: []
        }))
      })),
      ...(cleanFiles.length > 0 ? [{
        name: 'Clean Files (' + cleanFiles.length + ')',
        _isGroup: true,
        color: 'var(--green)',
        children: cleanFiles.map(sf => ({
          name: shortFileName(sf.fileName),
          _isFile: true,
          color: 'var(--green)',
          badge: '\u2713',
          badgeColor: '#16a34a',
          tooltip: { title: sf.fileName, rows: [['Status', 'No violations']] },
          children: []
        }))
      }] : [])
    ]
  };
}

function buildCheckTreeByProperty() {
  const byProp = {};
  data.check.diagnostics.forEach(d => {
    if (!byProp[d.property]) byProp[d.property] = [];
    byProp[d.property].push(d);
  });

  // Also add clean properties from summary
  if (data.check.summary && data.check.summary.byProperty) {
    Object.keys(data.check.summary.byProperty).forEach(p => {
      if (!byProp[p]) byProp[p] = [];
    });
  }

  const propNames = Object.keys(byProp).sort();

  return {
    name: 'Check Results by Property',
    _isGroup: true,
    color: 'var(--check-color)',
    tooltip: { title: 'Property Check Results', rows: [['Properties checked', propNames.length + '']] },
    children: propNames.map(prop => {
      const diags = byProp[prop];
      const isClean = diags.length === 0;
      return {
        name: prop,
        _isGroup: true,
        color: isClean ? 'var(--green)' : 'var(--red)',
        countText: isClean ? '\u2713 clean' : '(' + diags.length + ' violations)',
        tooltip: { title: prop, rows: [['Violations', diags.length + '']] },
        children: diags.map(d => {
          const sym = data.bind.symbols.find(s => s.id === d.symbolId);
          return {
            id: d.id,
            name: (sym ? sym.name : d.file) + ' — L' + d.line,
            color: 'var(--red)',
            badge: 'KS' + d.code,
            badgeColor: '#dc2626',
            tooltip: { title: 'KS' + d.code, rows: [['File', d.file], ['Line', d.line + ''], ['Message', d.message.slice(0, 80)]] },
            onClick: () => showCheckDetail(d),
            children: []
          };
        })
      };
    })
  };
}

// ============================================================
// TOOLTIP
// ============================================================
function showTooltip(event, info) {
  const tt = document.getElementById('tooltip');
  let html = '<div class="tt-title">' + escHtml(info.title) + '</div>';
  (info.rows || []).forEach(r => {
    html += '<div class="tt-row"><span class="tt-key">' + r[0] + '</span><span class="tt-val">' + escHtml(r[1]) + '</span></div>';
  });
  if (info.props && info.props.length > 0) {
    html += '<div class="tt-props">';
    info.props.forEach(p => {
      html += '<span class="tt-chip" style="background:rgba(74,222,128,0.12);color:#4ade80">' + p + '</span>';
    });
    html += '</div>';
  }
  tt.innerHTML = html;
  tt.style.display = 'block';
  const x = Math.min(event.clientX + 12, window.innerWidth - 360);
  const y = Math.min(event.clientY + 12, window.innerHeight - 200);
  tt.style.left = x + 'px';
  tt.style.top = y + 'px';
}

function hideTooltip() {
  document.getElementById('tooltip').style.display = 'none';
}

// ============================================================
// TREE NODE HIGHLIGHTING
// ============================================================
function highlightTreeNode(nodeId) {
  if (!nodeId) return;
  // Find and flash the matching node in the D3 tree
  d3.selectAll('g.tree-node').each(function(d) {
    if (d.data.id === nodeId) {
      const el = d3.select(this);
      el.select('rect.tree-node-bg')
        .attr('fill', 'rgba(124,106,247,0.18)')
        .transition().duration(2000)
        .attr('fill', 'transparent');
    }
  });
}

// ============================================================
// HELPERS
// ============================================================
function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function shortFileName(f) {
  if (!f) return '';
  const parts = f.split('/');
  return parts.length <= 2 ? f : parts.slice(-2).join('/');
}

function padNum(n) {
  const s = n + '';
  return s.length < 3 ? ('   ' + s).slice(-3) : s;
}

function kindColor(kind) {
  switch (kind) {
    case 'TypeAliasDeclaration': return '#22d3ee';
    case 'VariableStatement': return '#4f8ef7';
    case 'FunctionDeclaration': return '#fbbf24';
    case 'InterfaceDeclaration': return '#4ade80';
    case 'ImportDeclaration': return '#8a94a8';
    case 'ClassDeclaration': return '#f472b6';
    default: return '#8a94a8';
  }
}

function kindBadge(kind) {
  switch (kind) {
    case 'TypeAliasDeclaration': return 'T';
    case 'VariableStatement': return 'V';
    case 'FunctionDeclaration': return 'F';
    case 'InterfaceDeclaration': return 'I';
    case 'ImportDeclaration': return '\u2192';
    case 'ClassDeclaration': return 'C';
    default: return '?';
  }
}

function valueKindColor(sym) {
  if (sym.role === 'definition') return '#a78bfa';
  switch (sym.valueKind) {
    case 'function': return '#fbbf24';
    case 'directory': return '#4f8ef7';
    case 'file': return '#22d3ee';
    case 'composite': return '#fb923c';
    default: return '#8a94a8';
  }
}

function vkBadge(vk) {
  switch (vk) {
    case 'function': return '\u03BB';
    case 'directory': return 'DIR';
    case 'file': return 'FILE';
    case 'composite': return 'CMP';
    default: return '?';
  }
}

function propsChips(props) {
  if (!props) return '';
  const keys = Object.keys(props).filter(k => props[k]);
  if (keys.length === 0) return '';
  return keys.map(k => '<span style="font-size:9px;font-weight:700;padding:0 4px;border-radius:3px;background:rgba(74,222,128,0.1);color:#4ade80;margin-left:3px">' + k + '</span>').join('');
}

function highlightSource(src) {
  // Simple syntax highlighting
  return escHtml(src)
    .replace(/\b(type|const|let|var|function|export|import|from|declare|return|readonly|extends)\b/g, '<span class="hl-kw">$1</span>')
    .replace(/\b(string|number|boolean|void|true|false|unknown)\b/g, '<span class="hl-type">$1</span>')
    .replace(/(\/\/[^\n]*)/g, '<span class="hl-cmt">$1</span>')
    .replace(/('[^']*')/g, '<span class="hl-str">$1</span>');
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  loadData(SAMPLE_DATA);
});

// Resize handler
window.addEventListener('resize', () => { if (data) renderTree(); });
</script>
</body>
</html>
